<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Open Portfolio Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1 1 320px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #eee; text-align: left; }
    h1 { margin-top: 0; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; background: #fafafa; }
    input, select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 100%; }
    .error { color: #b00020; }
    .muted { color: #666; font-size: 0.95em; }
    .right { text-align: right; }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .hidden { display: none; }
  </style>
  <!-- Chart.js for the pie chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="topbar">
    <h1>Open Portfolio Manager</h1>
    <div id="userBox" class="muted"></div>
  </div>

  <!-- LOGIN CARD -->
  <div id="loginCard" class="card hidden" style="max-width:420px;">
    <h3>Sign in</h3>
    <div style="display:grid; gap:10px;">
      <label>Username
        <input id="username" placeholder="demo" />
      </label>
      <label>Password
        <input id="password" type="password" placeholder="demo123" />
      </label>
      <div style="display:flex; gap:8px;">
        <button id="loginBtn">Login</button>
        <button id="registerBtn">Register</button>
      </div>
      <div id="loginErr" class="error"></div>
      <p class="muted">Tip: pre-seeded <code>demo / demo123</code></p>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashWrap" class="hidden">
    <div class="row">
      <div class="col">
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Overview</h3>
            <div>
              <label class="muted">Base CCY
                <select id="baseCcy">
                  <option>GBP</option>
                  <option>USD</option>
                  <option>EUR</option>
                </select>
              </label>
              <button id="refreshBtn">Refresh</button>
              <button id="logoutBtn">Logout</button>
            </div>
          </div>
          <div id="totals" class="muted">Loading…</div>
          <table>
            <thead>
              <tr><th>Symbol</th><th>Type</th><th class="right">Qty</th><th class="right">Price</th><th class="right">Value</th></tr>
            </thead>
            <tbody id="positionsBody"></tbody>
          </table>
          <div id="overviewErr" class="error"></div>
        </div>

        <!-- Allocation Pie -->
        <div class="card">
          <h3>Allocation</h3>
          <canvas id="allocPie" height="240"></canvas>
          <div id="pieHint" class="muted"></div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <h3>Add Asset</h3>
          <div style="display:grid; gap:8px;">
            <label>Symbol <input id="assetSymbol" placeholder="e.g. XMR or NVDA or VOD.L" /></label>
            <label>Type
              <select id="assetType">
                <option value="crypto">crypto</option>
                <option value="equity">equity</option>
                <option value="metal">metal</option>
                <option value="manual">manual</option>
              </select>
            </label>
            <label>Source
              <select id="assetSource">
                <option value="coingecko">coingecko</option>
                <option value="yfinance">yfinance</option>
                <option value="manual">manual</option>
              </select>
            </label>
            <label>Source Ref <input id="assetRef" placeholder="coingecko id (monero) or Yahoo ticker (NVDA / XAGUSD=X)" /></label>
            <label>Native CCY (optional) <input id="assetNccy" placeholder="USD / GBX / etc" /></label>
            <button id="addAssetBtn">Add Asset</button>
            <div id="assetErr" class="error"></div>
          </div>
        </div>

        <div class="card">
          <h3>Add Holding</h3>
          <div style="display:grid; gap:8px;">
            <label>Asset Symbol <input id="holdSymbol" placeholder="e.g. XMR" /></label>
            <label>Quantity <input id="holdQty" type="number" step="any" placeholder="e.g. 2.5" /></label>
            <label>Account <input id="holdAcct" placeholder="Default" value="Default" /></label>
            <button id="addHoldBtn">Add Holding</button>
            <div id="holdErr" class="error"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>Your Holdings</h3>
      <table>
        <thead>
          <tr><th>ID</th><th>Account</th><th>Symbol</th><th>Type</th><th class="right">Qty</th><th></th></tr>
        </thead>
        <tbody id="holdsBody"></tbody>
      </table>
      <div id="holdsErr" class="error"></div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const setHidden = (el, hidden) => el.classList.toggle('hidden', !!hidden);
    const fmt = n => new Intl.NumberFormat().format(n);

    let pieChart = null; // Chart.js instance

    async function api(path, opts={}) {
      const res = await fetch(path, { credentials: "include", ...opts });
      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch {}
      if (!res.ok) {
        const err = (data && (data.detail || data.error)) || `HTTP ${res.status}`;
        throw new Error(err);
      }
      return data;
    }

    async function checkAuth() {
      try {
        const me = await api("/api/me");
        $("#userBox").textContent = `Signed in as ${me.display_name} (@${me.username})`;
        setHidden($("#loginCard"), true);
        setHidden($("#dashWrap"), false);
        await refreshAll();
      } catch {
        $("#userBox").textContent = "";
        setHidden($("#dashWrap"), true);
        setHidden($("#loginCard"), false);
      }
    }

    function renderPie(overview) {
      const ctx = $("#allocPie").getContext("2d");
      const labels = overview.items.map(r => r.symbol);
      const data = overview.items.map(r => r.value);

      // Destroy previous chart to avoid leaks
      if (pieChart) { pieChart.destroy(); pieChart = null; }

      if (!data.length) {
        $("#pieHint").textContent = "No valued positions yet. Add holdings or refresh.";
        return;
      }

      $("#pieHint").textContent = "";
      pieChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels,
          datasets: [{
            data,
            // default Chart.js colors; we intentionally don't hardcode colors
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const val = ctx.raw || 0;
                  const total = data.reduce((a,b)=>a+b,0) || 1;
                  const pct = (val / total) * 100;
                  return `${ctx.label}: ${fmt(val)} (${pct.toFixed(1)}%)`;
                }
              }
            }
          }
        }
      });
    }

    async function refreshAll() {
      $("#overviewErr").textContent = "";
      $("#holdsErr").textContent = "";
      const base = $("#baseCcy").value || "GBP";
      try {
        const ov = await api(`/api/overview?base_ccy=${encodeURIComponent(base)}`);
        $("#totals").textContent = `Base: ${ov.base_ccy} — Total: ${fmt(ov.total)}`;
        const tb = $("#positionsBody");
        tb.innerHTML = "";
        ov.items.forEach(r => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${r.symbol}</td>
            <td>${r.type}</td>
            <td class="right">${fmt(r.qty)}</td>
            <td class="right">${fmt(r.last_px)}</td>
            <td class="right">${fmt(r.value)}</td>
          `;
          tb.appendChild(tr);
        });
        renderPie(ov);
      } catch (e) {
        $("#overviewErr").textContent = e.message || "API error";
        renderPie({ items: [] }); // clear pie
      }

      try {
        const holds = await api("/api/holdings");
        const hb = $("#holdsBody");
        hb.innerHTML = "";
        holds.forEach(h => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${h.id}</td>
            <td>${h.account}</td>
            <td>${h.asset_symbol}</td>
            <td>${h.asset_type}</td>
            <td class="right">${fmt(h.qty)}</td>
            <td><button data-id="${h.id}" class="delBtn">Delete</button></td>
          `;
          hb.appendChild(tr);
        });
        hb.querySelectorAll(".delBtn").forEach(btn => {
          btn.addEventListener("click", async () => {
            const id = btn.getAttribute("data-id");
            try {
              await api(`/api/holdings/${id}`, { method: "DELETE" });
              await refreshAll();
            } catch (e) { alert(e.message); }
          });
        });
      } catch (e) {
        $("#holdsErr").textContent = e.message || "API error";
      }
    }

    // events
    $("#baseCcy").addEventListener("change", refreshAll);

    $("#loginBtn").addEventListener("click", async () => {
      $("#loginErr").textContent = "";
      const body = {
        username: $("#username").value.trim(),
        password: $("#password").value
      };
      try {
        await api("/api/auth/login", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(body)
        });
        await checkAuth();
      } catch (e) { $("#loginErr").textContent = e.message; }
    });

    $("#registerBtn").addEventListener("click", async () => {
      $("#loginErr").textContent = "";
      const body = {
        username: $("#username").value.trim(),
        password: $("#password").value,
        display_name: $("#username").value.trim() || "User"
      };
      try {
        await api("/api/auth/register", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(body)
        });
        await checkAuth();
      } catch (e) { $("#loginErr").textContent = e.message; }
    });

    $("#refreshBtn").addEventListener("click", refreshAll);

    $("#logoutBtn").addEventListener("click", async () => {
      try { await api("/api/auth/logout", { method: "POST" }); } catch {}
      await checkAuth();
    });

    $("#addAssetBtn").addEventListener("click", async () => {
      $("#assetErr").textContent = "";
      const body = {
        symbol: $("#assetSymbol").value,
        type: $("#assetType").value,
        source: $("#assetSource").value,
        source_ref: $("#assetRef").value,
        native_ccy: $("#assetNccy").value || null
      };
      try {
        const r = await api("/api/assets", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          credentials: "include",
          body: JSON.stringify(body)
        });
        alert(`Asset added: ${r.symbol}`);
      } catch (e) { $("#assetErr").textContent = e.message; }
    });

    $("#addHoldBtn").addEventListener("click", async () => {
      $("#holdErr").textContent = "";
      const body = {
        asset_symbol: $("#holdSymbol").value,
        qty: parseFloat($("#holdQty").value),
        account: $("#holdAcct").value || "Default"
      };
      try {
        await api("/api/holdings", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          credentials: "include",
          body: JSON.stringify(body)
        });
        await refreshAll();
      } catch (e) { $("#holdErr").textContent = e.message; }
    });

    // boot
    checkAuth();
  </script>
</body>
</html>
